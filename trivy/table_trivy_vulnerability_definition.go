package trivy

import (
	"context"
	"encoding/json"

	"github.com/aquasecurity/trivy-db/pkg/db"
	dbTypes "github.com/aquasecurity/trivy-db/pkg/types"
	"go.etcd.io/bbolt"

	"github.com/turbot/steampipe-plugin-sdk/v3/grpc/proto"
	"github.com/turbot/steampipe-plugin-sdk/v3/plugin"
	"github.com/turbot/steampipe-plugin-sdk/v3/plugin/transform"
)

func tableTrivyVulnerabilityDefinition(ctx context.Context) *plugin.Table {
	return &plugin.Table{
		Name:        "trivy_vulnerability_definition",
		Description: "Advisories.",
		List: &plugin.ListConfig{
			Hydrate: listTrivyVulnerabilityDefinition,
		},
		Columns: []*plugin.Column{
			// Top columns
			{Name: "name", Type: proto.ColumnType_STRING, Description: ""},
			{Name: "title", Type: proto.ColumnType_STRING, Description: ""},
			{Name: "severity", Type: proto.ColumnType_STRING, Description: ""},
			{Name: "cwe_ids", Type: proto.ColumnType_JSON, Transform: transform.FromField("CweIDs"), Description: ""},
			{Name: "vendor_severity", Type: proto.ColumnType_JSON, Description: ""},
			{Name: "cvss", Type: proto.ColumnType_JSON, Transform: transform.FromField("CVSS"), Description: ""},
			{Name: "references", Type: proto.ColumnType_JSON, Description: ""},
			{Name: "published_date", Type: proto.ColumnType_TIMESTAMP, Description: ""},
			{Name: "last_modified_date", Type: proto.ColumnType_TIMESTAMP, Description: ""},
			{Name: "description", Type: proto.ColumnType_STRING, Description: ""},
			{Name: "custom", Type: proto.ColumnType_JSON, Description: ""},
		},
	}
}

type vulnerabilityDefinitionRow struct {
	dbTypes.Vulnerability
	Name string
}

func listTrivyVulnerabilityDefinition(ctx context.Context, d *plugin.QueryData, h *plugin.HydrateData) (interface{}, error) {

	db.Init("/Users/nathan/Library/Caches/trivy")
	dbc := db.Config{}
	conn := dbc.Connection()
	conn.View(func(tx *bbolt.Tx) error {
		b := tx.Bucket([]byte("vulnerability"))
		c := b.Cursor()
		for k, v := c.First(); k != nil; k, v = c.Next() {
			var vd vulnerabilityDefinitionRow
			err := json.Unmarshal(v, &vd)
			if err != nil {
				continue
			}
			vd.Name = string(k)
			d.StreamListItem(ctx, vd)
		}
		return nil
	})

	return nil, nil
}
