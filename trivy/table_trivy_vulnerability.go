package trivy

import (
	"bytes"
	"context"
	"encoding/json"

	dbTypes "github.com/aquasecurity/trivy-db/pkg/types"
	"go.etcd.io/bbolt"

	"github.com/turbot/steampipe-plugin-sdk/v4/grpc/proto"
	"github.com/turbot/steampipe-plugin-sdk/v4/plugin"
	"github.com/turbot/steampipe-plugin-sdk/v4/plugin/transform"
)

func tableTrivyVulnerability(ctx context.Context) *plugin.Table {
	return &plugin.Table{
		Name:        "trivy_vulnerability",
		Description: "Vulnerability definitions used by Trivy when scanning.",
		List: &plugin.ListConfig{
			Hydrate: listTrivyVulnerability,
			KeyColumns: []*plugin.KeyColumn{
				{Name: "name", Require: plugin.Optional},
			},
		},
		Columns: []*plugin.Column{
			// Top columns
			{Name: "name", Type: proto.ColumnType_STRING, Description: "Name of the vulnerability, e.g. CVE-2022-1234."},
			{Name: "severity", Type: proto.ColumnType_STRING, Description: "Severity of the vulnerability, e.g. LOW, MEDIUM, HIGH, CRITICAL."},
			{Name: "published_date", Type: proto.ColumnType_TIMESTAMP, Description: "Date when the vulnerability was published."},
			{Name: "title", Type: proto.ColumnType_STRING, Description: "Title of the vulnerability."},
			// Other columns
			{Name: "cvss", Type: proto.ColumnType_JSON, Transform: transform.FromField("CVSS"), Description: "Common Vulnerability Scoring System details for the vulnerability."},
			{Name: "cwe_ids", Type: proto.ColumnType_JSON, Transform: transform.FromField("CweIDs"), Description: "Array of Common Weakness Enumeration IDs associated with this vulnerability, e.g. [CWE-252, CWE-384]."},
			{Name: "description", Type: proto.ColumnType_STRING, Description: "Description of the vulnerability."},
			{Name: "last_modified_date", Type: proto.ColumnType_TIMESTAMP, Description: "Date when the vulnerability was last modified."},
			{Name: "references", Type: proto.ColumnType_JSON, Description: "Reference URLs for the vulnerability."},
			{Name: "vendor_severity", Type: proto.ColumnType_JSON, Description: "Severity of the vulnerability as assigned by the vendor."},
			// Not populated? {Name: "custom", Type: proto.ColumnType_JSON, Description: "Custom information for the vulnerability."},
		},
	}
}

type vulnerabilityRow struct {
	Name string
	dbTypes.Vulnerability
}

func listTrivyVulnerability(ctx context.Context, d *plugin.QueryData, h *plugin.HydrateData) (interface{}, error) {

	conn, err := connectDatabase(ctx, d)
	if err != nil {
		plugin.Logger(ctx).Error("trivy_advisory.listTrivyVulnerability", "connection_error", err)
		return nil, err
	}

	err = conn.View(func(tx *bbolt.Tx) error {
		b := tx.Bucket([]byte("vulnerability"))
		c := b.Cursor()

		keyQuals := d.KeyColumnQuals
		namePrefix := []byte{}
		if keyQuals["name"] != nil {
			namePrefix = []byte(keyQuals["name"].GetStringValue())
		}

		for k, v := c.Seek(namePrefix); k != nil && bytes.HasPrefix(k, namePrefix); k, v = c.Next() {
			var vd vulnerabilityRow
			err := json.Unmarshal(v, &vd)
			if err != nil {
				plugin.Logger(ctx).Error("trivy_advisory.listTrivyVulnerability", "name", string(k), "value", string(v), "data_error", err)
				continue
			}
			vd.Name = string(k)
			d.StreamListItem(ctx, vd)
		}

		return nil
	})

	if err != nil {
		plugin.Logger(ctx).Error("trivy_advisory.listTrivyVulnerability", "conn_view_error", err)
	}

	return nil, err
}
